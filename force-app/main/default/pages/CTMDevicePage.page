<apex:page standardController="CTMDevice__c"  extensions="UserInfoController" sidebar="false" showHeader="false">
  <apex:includeScript value="/soap/ajax/61.0/connection.js"/>
  <apex:includeScript value="/soap/ajax/61.0/apex.js"/>
  <div id="ctmDevicePage">
    <button style="background:#03bdf5;margin:40px;border:none;padding:10px;box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);color: #fff;border-radius: 4px;">Click to Start Device</button>
  </div>
  <script>
    function getAccessAndLoadFrame() {
      document.getElementById('ctmDevicePage').innerHTML = 'Loading...';
      Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.UserInfoController.getCTMAccessToken}', 'info=ctm', (result, event) => {
        //console.log('result:', result, ", event:", event);
        if (event.status) {
          const decodedResult = decodeURIComponent(result.replace(new RegExp('&'.replace(/#38/,'') + 'quot' + ';', 'g'), '"'));
          //console.log('decodedResult:', decodedResult);
          const obj         = JSON.parse(decodedResult);
          const token       = obj.token;
          const session     = obj.sessionId;
          const email       = obj.email;

          const iframe = document.createElement('iframe');
          iframe.src = `https://app.calltrackingmetrics.com/phoneapp/embed_device?token=${token}&session=${session}&email=${email}`;
          //console.log("load frame:", iframe.src);
          iframe.style="width:100%;min-height:400px;border:none";
          // geolocation *; microphone *; camera *
          iframe.allow="geolocation; microphone; camera; idle-detection; screen-wake-lock";
          iframe.frameborder = 'no';

          document.getElementById('ctmDevicePage').innerHTML = '';
          document.getElementById('ctmDevicePage').appendChild(iframe);
        } else {
          console.error(event);
          document.getElementById('ctmDevicePage').innerHTML = '<h3>Error loading CTM Device Page</h3><p>Please contact support for assistance.  If you are an administrator please navigate to CallTrackingMetrics settings and run the installation again.</p>';
        }
      });
    }
    document.querySelector('#ctmDevicePage button').addEventListener('click', (e) => {
      if (sessionStorage.getItem('refreshed')) {
        getAccessAndLoadFrame();
      } else {
        sessionStorage.setItem('refreshed', 1);
        window.location.reload();
      }
    });
    //if (sessionStorage.getItem('refreshed')) {
      getAccessAndLoadFrame();
    //}
  </script>
</apex:page>